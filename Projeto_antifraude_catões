import requests
import json
import uuid
import os
import argparse # Importa o módulo para análise de argumentos de linha de comando

# --- Constantes da API ---
API_VERSION = "3.0"
# ========================

# Função para traduzir texto usando o Azure Translator
def traduzir_texto(texto: str, idioma_destino: str, idioma_origem: str = None) -> str:
    """
    Traduz um texto utilizando o serviço Azure Translator.

    Args:
        texto (str): O texto a ser traduzido.
        idioma_destino (str): O código do idioma para o qual o texto será traduzido (ex: 'pt', 'en', 'es').
        idioma_origem (str, optional): O código do idioma de origem. Se None, a API tentará detectar automaticamente.

    Returns:
        str: O texto traduzido, ou None se ocorrer um erro.
    """
    subscription_key = os.getenv('AZURE_TRANSLATOR_KEY')
    endpoint = os.getenv('AZURE_TRANSLATOR_ENDPOINT')
    region = os.getenv('AZURE_TRANSLATOR_REGION')

    if not subscription_key or not endpoint or not region:
        print(" ERRO: As credenciais do Azure (AZURE_TRANSLATOR_KEY, AZURE_TRANSLATOR_ENDPOINT, AZURE_TRANSLATOR_REGION) não estão configuradas como variáveis de ambiente.")
        print("Por favor, defina-as antes de executar a aplicação. Consulte a documentação para mais detalhes.")
        return None

    path = f'/translate?api-version={API_VERSION}'
    params = f'&to={idioma_destino}'
    if idioma_origem:
        params += f'&from={idioma_origem}'
    constructed_url = endpoint + path + params

    headers = {
        'Ocp-Apim-Subscription-Key': subscription_key,
        'Ocp-Apim-Subscription-Region': region,
        'Content-type': 'application/json',
        'X-ClientTraceId': str(uuid.uuid4())
    }

    body = [{'text': texto}]

    try:
        print(f" Enviando requisição de tradução para Azure Translator...")
        response = requests.post(constructed_url, headers=headers, json=body)
        response.raise_for_status() # Lança um HTTPError para status de erro (4xx ou 5xx)

        response_data = response.json()
        traducoes = [item['translations'][0]['text'] for item in response_data if 'translations' in item and len(item['translations']) > 0]

        return traducoes[0] if traducoes else None

    except requests.exceptions.HTTPError as http_err:
        print(f" ERRO HTTP ({http_err.response.status_code}): {http_err} - Resposta da API: {http_err.response.text}")
        if http_err.response.status_code == 401:
            print("Verifique sua AZURE_TRANSLATOR_KEY. Ela pode estar inválida ou expirada.")
        elif http_err.response.status_code == 403:
            print("Verifique sua AZURE_TRANSLATOR_REGION. Ela pode não corresponder ao seu recurso ou haver um problema de permissão.")
        return None
    except requests.exceptions.ConnectionError as conn_err:
        print(f" ERRO DE CONEXÃO: Verifique sua conexão com a internet ou o endpoint do Azure ('{endpoint}'). Detalhes: {conn_err}")
        return None
    except requests.exceptions.Timeout as timeout_err:
        print(f" ERRO DE TEMPO LIMITE: A requisição para o Azure Translator excedeu o tempo limite. Detalhes: {timeout_err}")
        return None
    except requests.exceptions.RequestException as req_err:
        print(f" ERRO GERAL NA REQUISIÇÃO: Ocorreu um erro ao chamar a API do Azure Translator. Detalhes: {req_err}")
        return None
    except json.JSONDecodeError:
        print(f" ERRO AO DECODIFICAR JSON: A resposta da API não é um JSON válido. Resposta recebida: {response.text if 'response' in locals() else 'N/A'}")
        return None
    except Exception as e:
        print(f" ERRO INESPERADO: {e}")
        return None

# Nova função para listar idiomas suportados
def listar_idiomas_suportados():
    """
    Consulta e exibe a lista de idiomas suportados pelo Azure Translator.
    """
    subscription_key = os.getenv('AZURE_TRANSLATOR_KEY')
    endpoint = os.getenv('AZURE_TRANSLATOR_ENDPOINT')
    region = os.getenv('AZURE_TRANSLATOR_REGION') # Necessário para o endpoint global ou regional

    if not subscription_key or not endpoint: # A região não é estritamente necessária para a rota /languages, mas é bom ter
        print(" ERRO: As variáveis de ambiente AZURE_TRANSLATOR_KEY e AZURE_TRANSLATOR_ENDPOINT devem estar configuradas para listar os idiomas.")
        return

    # O endpoint para /languages não precisa ser regional se o endpoint principal for global
    # Usaremos o endpoint principal configurado
    languages_url = f"{endpoint}/languages?api-version={API_VERSION}"

    headers = {
        'Ocp-Apim-Subscription-Key': subscription_key,
        'Ocp-Apim-Subscription-Region': region, # Incluímos a região por segurança
        'Content-type': 'application/json'
    }

    try:
        print(" Consultando idiomas suportados...")
        response = requests.get(languages_url, headers=headers)
        response.raise_for_status()
        languages_data = response.json()

        print("\n Idiomas Suportados para Tradução:")
        print("-----------------------------------")
        if 'translation' in languages_data:
            sorted_languages = sorted(languages_data['translation'].items(), key=lambda x: x[1]['name'])
            for code, details in sorted_languages:
                print(f"- {code}: {details['name']} ({details['nativeName']})")
        else:
            print("Não foi possível encontrar a seção 'translation' na resposta.")
        print("-----------------------------------")

    except requests.exceptions.HTTPError as http_err:
        print(f" ERRO HTTP ao listar idiomas ({http_err.response.status_code}): {http_err} - Resposta: {http_err.response.text}")
    except requests.exceptions.RequestException as req_err:
        print(f" ERRO ao conectar à API para listar idiomas: {req_err}")
    except json.JSONDecodeError:
        print(f" ERRO ao decodificar JSON da resposta de idiomas: {response.text}")
    except Exception as e:
        print(f" ERRO INESPERADO ao listar idiomas: {e}")


def main():
    parser = argparse.ArgumentParser(
        description=" Aplicação de Tradução de Texto com Azure Translator ",
        formatter_class=argparse.RawTextHelpFormatter # Preserva a formatação de nova linha na descrição
    )

    # Argumento para listar idiomas
    parser.add_argument(
        '-l', '--list-languages',
        action='store_true',
        help='Lista todos os idiomas suportados pelo Azure Translator e sai.'
    )

    # Argumentos para tradução de texto
    parser.add_argument(
        '-t', '--text',
        type=str,
        help='O texto a ser traduzido.'
    )
    parser.add_argument(
        '-to', '--to-language',
        type=str,
        help='O código do idioma para o qual traduzir (ex: pt, en, es).'
    )
    parser.add_argument(
        '-f', '--from-language',
        type=str,
        default=None,
        help='O código do idioma de origem (ex: en). Se não fornecido, o Azure tentará auto-detectar.'
    )

    args = parser.parse_args()

    # Se o usuário pediu para listar idiomas
    if args.list_languages:
        listar_idiomas_suportados()
        return # Sai após listar

    # Se nenhum argumento de tradução foi fornecido, entra no modo interativo ou mostra ajuda
    if not args.text and not args.to_language:
        print("Nenhum texto (-t) ou idioma de destino (-to) foi fornecido. Entrando no modo interativo.")
        texto_original = input(" Digite o texto a ser traduzido: ").strip()
        if not texto_original:
            print(" Texto não pode ser vazio.")
            return

        idioma_origem_input = input(" Digite o código do idioma de origem (ex: 'en', 'pt', 'es') ou pressione Enter para auto-detectar: ").strip()
        idioma_origem = idioma_origem_input if idioma_origem_input else None

        idioma_destino = input(" Digite o código do idioma de destino (ex: 'pt', 'en', 'es'): ").strip()
        if not idioma_destino:
            print(" O código do idioma de destino é obrigatório.")
            return

    else: # Modo CLI com argumentos
        texto_original = args.text
        idioma_destino = args.to_language
        idioma_origem = args.from_language

        if not texto_original:
            print(" ERRO: O texto a ser traduzido (--text) é obrigatório no modo CLI.")
            parser.print_help()
            return
        if not idioma_destino:
            print(" ERRO: O idioma de destino (--to-language) é obrigatório no modo CLI.")
            parser.print_help()
            return

    # Chama a função de tradução
    print(f"\n--- Detalhes da Tradução ---")
    print(f"Texto original (entrada): '{texto_original}'")
    print(f"Idioma de origem (solicitado): {idioma_origem if idioma_origem else 'Auto-detecção'}")
    print(f"Idioma de destino (solicitado): {idioma_destino}")
    print("---------------------------\n")

    traducao = traduzir_texto(texto_original, idioma_destino, idioma_origem)

    # Exibe o resultado ou uma mensagem de erro
    if traducao:
        print("\n Tradução Concluída com Sucesso!")
        print(f" Texto traduzido para '{idioma_destino}':\n")
        print(f""""\n{traducao}\n"""")
    else:
        print("\n Não foi possível realizar a tradução. Verifique as mensagens de erro acima e suas configurações.")

if __name__ == "__main__":
    main()
