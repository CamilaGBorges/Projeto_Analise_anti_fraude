#7. main.py (Orquestrador Principal)

#Este √© o script que voc√™ executaria para iniciar o pipeline.

# fraud_detection_project/main.py
import os
from data_generator import generate_synthetic_data
from feature_engineering import create_features
from model_trainer import train_and_evaluate_model
from fraud_detector import FraudDetector
from utils import get_secret_from_keyvault # Para demonstra√ß√£o de acesso seguro

def run_fraud_detection_pipeline():
    """
    Executa o pipeline completo de detec√ß√£o de fraude:
    Gera√ß√£o de dados -> Engenharia de Features -> Treinamento do Modelo -> Simula√ß√£o de Detec√ß√£o.
    """
    print("--- üöÄ Iniciando Pipeline de Detec√ß√£o de Fraudes üöÄ ---")

    # --- 1. Gera√ß√£o de Dados Sint√©ticos ---
    # Em um ambiente real, esta etapa seria a ingest√£o de dados de um Azure Event Hubs,
    # Azure Data Factory, ou lendo do Azure Data Lake Storage.
    print("\n--- Etapa 1: Gera√ß√£o de Dados ---")
    raw_transactions_df = generate_synthetic_data(num_transactions=10000, fraud_ratio=0.015)
    
    # Conceito: Salvar dados brutos em Azure Data Lake Storage
    # raw_transactions_df.to_parquet("abfss://raw-data@<sua_conta>.dfs.core.windows.net/transactions.parquet")

    # --- 2. Engenharia de Features ---
    # Esta etapa ocorreria em Azure Databricks ou Azure Synapse Spark Pools para grandes volumes.
    print("\n--- Etapa 2: Engenharia de Features ---")
    features_df = create_features(raw_transactions_df)
    
    # Conceito: Salvar features processadas em Azure Data Lake Storage
    # features_df.to_parquet("abfss://processed-data@<sua_conta>.dfs.core.windows.net/features.parquet")


    # --- 3. Treinamento e Avalia√ß√£o do Modelo ---
    # Esta etapa seria gerenciada pelo Azure Machine Learning.
    print("\n--- Etapa 3: Treinamento do Modelo ---")
    model_file_path = "fraud_detection_model.pkl" # Nome do arquivo para o modelo salvo
    train_and_evaluate_model(features_df, model_path=model_file_path)

    # Conceito: Registrar o modelo no Azure ML Model Registry
    # O `model_trainer.py` j√° cont√©m um exemplo comentado.

    # --- 4. Simula√ß√£o de Detec√ß√£o de Fraude (Infer√™ncia) ---
    # Em produ√ß√£o, a infer√™ncia seria via Azure Functions, Azure ML Endpoint ou Azure Kubernetes Service (AKS).
    print("\n--- Etapa 4: Simula√ß√£o de Detec√ß√£o ---")
    detector = FraudDetector(model_path=model_file_path)

    if detector.model:
        # Exemplo de transa√ß√£o em tempo real (dicion√°rio representando uma nova transa√ß√£o)
        new_transaction_data = {
            'user_id': 'USER999',
            'merchant_id': 'MERCH123',
            'timestamp': pd.to_datetime('2024-01-01 15:30:00'), # Exemplo de timestamp
            'amount': 2500.00, # Valor relativamente alto
            'card_type': 'Amex',
            'country': 'AR', # Pa√≠s diferente do habitual para o usu√°rio
            # 'is_fraud': 0 # N√£o fornecido em produ√ß√£o
        }
        
        proba, is_fraud = detector.predict_fraud(new_transaction_data)

        print(f"\n--- Resultado da Detec√ß√£o para Transa√ß√£o de {new_transaction_data['amount']:.2f} do usu√°rio {new_transaction_data['user_id']} ---")
        print(f"Probabilidade de fraude: {proba:.4f}")
        print(f"Decis√£o: {'FRAUDE DETECTADA!' if is_fraud else 'TRANSA√á√ÉO NORMAL.'}")
        print("---------------------------------------------------------------------------------\n")
    else:
        print(" N√£o foi poss√≠vel realizar a simula√ß√£o de detec√ß√£o, o modelo n√£o foi carregado.")

    # --- 5. Demonstra√ß√£o de Acesso Seguro a Segredos (Conceitual) ---
    # Em um ambiente Azure, o Identity do servi√ßo (Managed Identity) faria a autentica√ß√£o autom√°tica.
    print("\n--- Demonstra√ß√£o de Acesso Seguro a Segredos (Conceitual) ---")
    try:
        # Lembre-se: 'minha-chave-de-api-de-pagamento' √© um placeholder.
        # Voc√™ deve criar um segredo real no seu Azure Key Vault com o nome que quiser.
        # E definir a vari√°vel de ambiente AZURE_KEY_VAULT_URL.
        db_connection_string = get_secret_from_keyvault("DB-CONNECTION-STRING")
        if db_connection_string:
            print(f"String de conex√£o ao DB (parcial): {db_connection_string[:15]}...")
        else:
            print("N√£o foi poss√≠vel obter a string de conex√£o do DB. Verifique a configura√ß√£o do Key Vault e permiss√µes.")
    except ValueError as e:
        print(f"Configura√ß√£o do Key Vault incompleta para demonstra√ß√£o: {e}")
    except Exception as e:
        print(f"Ocorreu um erro ao tentar acessar o Key Vault: {e}")


    print("\n---  Pipeline de Detec√ß√£o de Fraudes Conclu√≠do  ---")

if __name__ == "__main__":
    # Certifique-se de configurar as vari√°veis de ambiente necess√°rias
    # Ex: export AZURE_KEY_VAULT_URL="https://seu-key-vault-name.vault.azure.net/"
    # Lembre-se que para rodar localmente com DefaultAzureCredential, voc√™ pode precisar
    # de "az login" ou configurar as vari√°veis AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID.

    run_fraud_detection_pipeline()
